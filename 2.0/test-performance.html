<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Test - Environmental Decorations</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #222;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        #info {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        #stats {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
        }
        #controls {
            margin: 20px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        #scene-container {
            width: 800px;
            height: 600px;
            border: 2px solid #555;
            position: relative;
        }
        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="info">
        <h1>Environmental Decorations Performance Test</h1>
        <p>Testing the performance impact of environmental decorations on the Snake Game.</p>
        <div id="status">Initializing...</div>
    </div>

    <div id="stats">
        <div>FPS: <span id="fps">--</span></div>
        <div>Frame Time: <span id="frametime">--</span>ms</div>
        <div>Decorations: <span id="decorations-count">0</span></div>
        <div>Theme: <span id="current-theme">--</span></div>
    </div>

    <div id="controls">
        <button id="btn-classic" onclick="switchTheme('classic')">Classic Farm</button>
        <button id="btn-desert" onclick="switchTheme('desert')">Desert</button>
        <button id="btn-snow" onclick="switchTheme('snow')">Snow</button>
        <button id="btn-forest" onclick="switchTheme('forest')">Forest</button>
        <br>
        <button id="btn-toggle-decorations" onclick="toggleDecorations()">Toggle Decorations</button>
        <button id="btn-reset" onclick="resetScene()">Reset Scene</button>
    </div>

    <div id="scene-container"></div>

    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js';
        import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/controls/OrbitControls.js';
        import { initBoardThemeManager, setBoardTheme, getCurrentBoardTheme, applyBoardThemeToScene } from './board-theme-manager.js';
        import { createEnvironmentalDecorations, removeEnvironmentalDecorations, animateEnvironmentalDecorations } from './obstacles.js';
        import { generateBoard, generateBoardHitboxes, getCurrentCamera, initializeCamera } from './scene.js';

        // Global variables
        let scene, camera, renderer, controls;
        let environmentalDecorations = [];
        let decorationsEnabled = true;
        let animationId;
        let lastTime = 0;
        let frameCount = 0;
        let fpsUpdateTime = 0;

        // Initialize the test environment
        async function init() {
            try {
                updateStatus('Initializing 3D scene...', 'info');
                
                // Create scene
                scene = new THREE.Scene();
                
                // Create camera
                camera = new THREE.PerspectiveCamera(75, 800/600, 0.1, 1000);
                camera.position.set(30, 40, 30);
                camera.lookAt(20, 0, 20);

                // Create renderer
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(800, 600);
                renderer.setClearColor(0x87CEEB);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                const container = document.getElementById('scene-container');
                container.appendChild(renderer.domElement);

                // Add controls
                controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;

                // Add lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(50, 50, 25);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                scene.add(directionalLight);

                // Initialize board theme manager
                updateStatus('Initializing board theme manager...', 'info');
                initBoardThemeManager();

                // Create game board
                updateStatus('Creating game board...', 'info');
                generateBoard(scene, 40, 40);

                // Apply initial theme
                updateStatus('Applying board theme...', 'info');
                await applyBoardThemeToScene(scene);

                // Create environmental decorations
                updateStatus('Creating environmental decorations...', 'info');
                await createEnvironmentalDecorations(scene).then(decorations => {
                    environmentalDecorations = decorations || [];
                    updateDecorationsCount();
                    updateStatus('Environmental decorations created successfully!', 'success');
                }).catch(error => {
                    console.error('Failed to create environmental decorations:', error);
                    updateStatus('Failed to create environmental decorations: ' + error.message, 'error');
                });

                // Update theme display
                updateCurrentTheme();

                // Start animation loop
                animate();

                updateStatus('Performance test ready!', 'success');

            } catch (error) {
                console.error('Initialization error:', error);
                updateStatus('Initialization failed: ' + error.message, 'error');
            }
        }

        // Animation loop with performance monitoring
        function animate(time = 0) {
            animationId = requestAnimationFrame(animate);

            // Calculate FPS and frame time
            frameCount++;
            const deltaTime = time - lastTime;
            
            if (time - fpsUpdateTime >= 1000) { // Update every second
                const fps = Math.round(frameCount * 1000 / (time - fpsUpdateTime));
                document.getElementById('fps').textContent = fps;
                document.getElementById('frametime').textContent = Math.round(deltaTime * 100) / 100;
                frameCount = 0;
                fpsUpdateTime = time;
            }

            lastTime = time;

            // Update controls
            if (controls) controls.update();

            // Animate environmental decorations if enabled
            if (decorationsEnabled && environmentalDecorations && environmentalDecorations.length > 0) {
                try {
                    animateEnvironmentalDecorations(environmentalDecorations, time * 0.001);
                } catch (error) {
                    console.error('Animation error:', error);
                }
            }

            // Render
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }        // Theme switching function
        window.switchTheme = async function(themeName) {
            try {
                updateStatus(`Switching to ${themeName} theme...`, 'info');
                
                // Set new theme
                const themeResult = setBoardTheme(themeName);
                if (!themeResult.changed) {
                    updateStatus(`Theme was already set to ${themeName}`, 'info');
                    return;
                }
                
                // Apply theme to scene
                await applyBoardThemeToScene(scene);
                
                // Recreate decorations using the new utility function
                if (decorationsEnabled) {
                    const { recreateEnvironmentalDecorations } = await import('./board-theme-manager.js');
                    environmentalDecorations = await recreateEnvironmentalDecorations(scene, environmentalDecorations) || [];
                } else {
                    // Just remove existing decorations if decorations are disabled
                    if (environmentalDecorations.length > 0) {
                        removeEnvironmentalDecorations(scene, environmentalDecorations);
                        environmentalDecorations = [];
                    }
                }

                updateCurrentTheme();
                updateDecorationsCount();
                updateStatus(`Switched to ${themeName} theme successfully!`, 'success');

            } catch (error) {
                console.error('Theme switch error:', error);
                updateStatus('Failed to switch theme: ' + error.message, 'error');
            }
        };

        // Toggle decorations
        window.toggleDecorations = async function() {
            decorationsEnabled = !decorationsEnabled;
            
            if (decorationsEnabled) {
                updateStatus('Enabling environmental decorations...', 'info');
                try {
                    environmentalDecorations = await createEnvironmentalDecorations(scene) || [];
                    updateStatus('Environmental decorations enabled!', 'success');
                } catch (error) {
                    updateStatus('Failed to enable decorations: ' + error.message, 'error');
                }
            } else {
                updateStatus('Disabling environmental decorations...', 'info');
                removeEnvironmentalDecorations(scene, environmentalDecorations);
                environmentalDecorations = [];
                updateStatus('Environmental decorations disabled!', 'success');
            }

            updateDecorationsCount();
            document.getElementById('btn-toggle-decorations').textContent = 
                decorationsEnabled ? 'Disable Decorations' : 'Enable Decorations';
        };

        // Reset scene
        window.resetScene = async function() {
            updateStatus('Resetting scene...', 'info');
            try {
                // Remove all decorations
                removeEnvironmentalDecorations(scene, environmentalDecorations);
                environmentalDecorations = [];

                // Recreate decorations if enabled
                if (decorationsEnabled) {
                    environmentalDecorations = await createEnvironmentalDecorations(scene) || [];
                }

                updateDecorationsCount();
                updateStatus('Scene reset successfully!', 'success');
            } catch (error) {
                updateStatus('Failed to reset scene: ' + error.message, 'error');
            }
        };

        // Helper functions
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = type;
        }

        function updateCurrentTheme() {
            document.getElementById('current-theme').textContent = getCurrentBoardTheme();
        }

        function updateDecorationsCount() {
            document.getElementById('decorations-count').textContent = environmentalDecorations.length;
        }

        // Initialize when page loads
        window.addEventListener('load', init);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });
    </script>
</body>
</html>
